<!DOCTYPE HTML>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8"/>
<meta name="Viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

<title>Meter Value Retrieve Tool</title>

<link rel="stylesheet" href="../jquery/jquery-ui.min.css" />

<style>
body {
  padding: 5px 10px 10px 20px;
  font-family: sans-serif;
}

.tag {
	margin: 0 5px 0 10px;
	vertical-align: baseline;
	font-size: 18px;
}
.date {
	vertical-align: baseline;
	padding: 8px 2px 2px 2px;
	border: none;
	border-radius: 4px;
	background: lightblue;
	font-size:16px;
	font-weight: bold;
}
.button {
	font-size: 18px;
	border: none;
	border-radius: 4px;
	padding:3px 10px;
	vertical-alignd: middle;
}
</style>
<script src="../jquery/jquery-2.1.3.min.js"></script>
<script src="../jquery-ui-1.11.2/jquery-ui.min.js"></script>
<script src="../script/CommModule.js"></script>
<script src="../script/GlobalVal.js"></script>

<script>

var DATA_ARRAY = {};
var FROM;
var TO;

$(document).ready(function() {
});

function showLoginPage() {

}

function command_dispatch(command,result,data) {
	data = data[0];
	switch(command) {
		case 'login':
			if(result == 'OK') {
				console.log('Login');
				COMM_PORT.send(['get_point_list']);
			} else {
				alert(getString('login_failed'));
				COMM_PORT.closeConnection();
				document.body.style.cursor = 'auto';
			}
			break;
		case 'logout':
			document.body.style.cursor = 'auto';
			return false;
			break;				
		case 'get_point_list':
			if(result == 'OK') {
				// read point list
				POINT_ID_LIST = [];
				var point_list = data;
				for(var i in point_list) {
					var point = point_list[i];
					if(point.type == 'Pi' || point.type == 'SPi') POINT_ID_LIST.push(point.id);
				}
				console.log("Retrieve point data");
				if(retrieve() == false) {
					document.body.style.cursor = 'auto';
					return false;
				} 
			} else {
				alert("Fail to read point list");
				document.body.style.cursor = 'auto';
				return false;
			}
			break;
		case 'get_pi_val':
			if(result == 'OK') {
				console.log("Data is retrieved");
				for(var id in data) {
					var point_data = data[id];
					for(var t = 0; t < point_data.length; t++) {
						d = point_data[t];
						DATA_ARRAY[d[0]][id] = d[2]; 
					}
				}
				var csv = make_csv();
				var fileName = 'MeterData'+'.csv';

			  var BOM = "\uFEFF";
			  var csv = BOM + csv;

			  csvFile = new Blob([csv], {type: "text/csv;charset=utf-8,%EF%BB%BF"});
			  var downloadLink = document.createElement("a");
			  downloadLink.download = fileName;
			  downloadLink.href = window.URL.createObjectURL(csvFile);
			  downloadLink.style.display = "none";
			  document.body.appendChild(downloadLink);
			  downloadLink.click();
			} else {
				alert("Fail to retrieve data");
			}
			console.log("Close connection");
			document.body.style.cursor = 'auto';
			COMM_PORT.closeConnection();
		default:
	}
	return true;
}

function connect() {
	document.body.style.cursor = 'wait';
	COMM_PORT.connectServer(location.hostname,"admin","DAIKINservice");	
}

function retrieve() {
	var from = $('#from').val();
	if(from == '') {alert("Please select date");return false;}
	var to = $('#to').val();
	if(to == '') {alert("Please select date");return false;}
	FROM = new Date(from+' 00:00').getTime()/1000;
	TO = new Date(to+' 00:00').getTime()/1000+(24*60*60);	 // TO is not included
	if(FROM > TO) {
		alert("Please input later date for 'To'.");
		return false;
	}
	console.log(FROM+","+TO);
	var num = (TO-FROM)/(15*60)-1;
	DATA_ARRAY = {};	// DATE_ARRAY {time_t:{pid:data,...},...}
	var i = 0;
	for(var t = FROM; t < TO; t+=(15*60)) {
		DATA_ARRAY[t] = {};
	}
	var com = ["get_pi_val",{"from":FROM,"to":TO,"id":POINT_ID_LIST}];
	COMM_PORT.send(com);
	return true;
}

function make_csv() {
	var saveData = '';
	var rt = '\r\n';

	var line;

	saveData = 'Date,Time';
	for(var i = 0; i < POINT_ID_LIST.length; i++) {
		saveData += (','+POINT_ID_LIST[i]);
	}
	saveData += rt;
	for(var t = FROM; t < TO; t+=(15*60)) {
		date = new Date(t*1000);
		var line = date.toLocaleDateString()+','+date.toLocaleTimeString().slice(0,-3);
		var data = DATA_ARRAY[t];
		for(var i = 0; i < POINT_ID_LIST.length; i++) {
			line += ',';
			if(data[POINT_ID_LIST[i]] != null) line += data[POINT_ID_LIST[i]];
		}
		line += rt;
		saveData += line;
	}
	return saveData;
}

</script>

</head>
<body>
<h1>Meter Value Retriever</h1>
<h2>Period</h2>
<span class='tag'>From</span><input type='date' class='date' id='from'></input><span class='tag'>To</span><input type='date' class='date' id='to'></input>
<input class='button' type='button' value='Retrieve' onclick='connect()'></input>
</body>
</html>
