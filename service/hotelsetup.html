<!DOCTYPE HTML>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8"/>
<meta name="Viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>

<title>Guest Room Setting</title>

<link rel="stylesheet" href="../jquery/jquery-ui.min.css" />
<link rel="stylesheet" href="../css/svmparts.css">

<style>
body {
	background-color: darkblue;
	margin: 5px;
}

.button {
	margin: 10px;
}

form {
	display: inline-block;
	margin-top: 20px;
}
input {
	font-size: 16px;
}
</style>
<script src="../jquery/jquery-2.1.3.min.js"></script>
<script src="../jquery-ui-1.11.2/jquery-ui.min.js"></script>
<script src="../script/CommModule.js"></script>
<script src='../script/svmparts.js'></script>
<script src="../script/GlobalVal.js"></script>

<script>

$(document).ready(function() {
	// read device_list.json
});

$(document).on('click','.button#pnt',function(e) {
	$.ajax({
		type: "POST",
		url: "../server/get_pointlist.rb",
		async: false,
		dataType: "json"
	}).then(
		function(data) {
			var csv = '';
			csv += 'Version,2\r\n';
			csv += '#controller id,room name,point id\r\n';
			for(var i in data) {
				if(data[i][1].type == 'Fcu') {
					csv += (','+data[i][1].name+','+data[i][1].id+'\r\n');
				}
			}
			save_csv(csv,'point_list.csv');
		},
		function() {
			alert('Fail to read point list');
		}
	);
});

$(document).on('click','.button#room',function(e) {
	$.ajax({
		type: "POST",
		url: "../server/room_list.csv",
		async: false,
		dataType: "text"
	}).then(
		function(data) {
			save_csv(data,'room_list.csv');
		},
		function() {
			alert('Fail to read point list');
		}
	);
});

$(document).on('click','.button#save',function(e) {
	var fd = new FormData();
	var $file = $('#file-form');
	fd.append($file.attr('name'),$file.prop('files')[0]);
	$.ajax({
		url: '../server/roomlist_save.rb',
		method: 'post',
		async: false,
		data: fd,
		processData: false,
		contentType: false,
		success: function(data) {
			alert(data);
		},
		error: function(e) {
			alert(e);
		}
	});		
});

function save_csv(csv,filename) {
  var csvFile;
  var downloadLink;
  
  var BOM = "\uFEFF";
  var csv = BOM + csv;

  csvFile = new Blob([csv], {type: "text/csv;charset=utf-8,%EF%BB%BF"});
  downloadLink = document.createElement("a");
  downloadLink.download = filename;
  downloadLink.href = window.URL.createObjectURL(csvFile);
  downloadLink.style.display = "none";
  document.body.appendChild(downloadLink);
  downloadLink.click();
}
</script>

</head>
<body>
	<h1 class='page-title'>Guest Rooms Setting</h1>

	<div class='button' id='pnt'>Load Point List</div>
	<div class='button' id='room'>Load Room List</div>
	<div></div>
	<form method='post' enctype=text/plain>
		<input type='file' id='file-form' name='room-list'>
	</form>
	<div class='button' id='save'>Save Room List</div>
</body>
</html>
